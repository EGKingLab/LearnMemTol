---
title: "Visualizing_TTRNA_Data"
author: "Patricka Williams-Simon"
date: "8/20/2018"
output: html_document
---
https://rpubs.com/kapeelc12/Ballgown
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DESeq2)
library(dplyr)
library(stringr)
library(sva)
library(ggplot2)
library(cowplot)
library(tidyverse)
library(colorspace)
library(ggrepel)

theme_set(theme_cowplot())

source(file="../../../Functions/ggplot_theme.R")


options(scipen=10)

```

# MA plot


```{r}

load(file="../Data/FoldChangeAll.Rda")

FC_All <- FC_All %>% 
  filter(baseMean > 0)


#identify num of genes that are significant in pool treatment
ww <-which(FC_All$padj_Pool_Overall < 0.05)
length(ww)
sig.Pgenes <- FC_All[ww,]
nrow(sig.Pgenes[sig.Pgenes$FC_Pool_Overall>0,])
nrow(sig.Pgenes[sig.Pgenes$FC_Pool_Overall<0,])

#identify num of genes that are significant in condition treatment
ww <-which(FC_All$padj_Cond_Overall < 0.05)
length(ww)
sig.Cgenes <- FC_All[ww,]
nrow(sig.Cgenes[sig.Cgenes$FC_Cond_Overall>0,])
nrow(sig.Cgenes[sig.Cgenes$FC_Cond_Overall<0,])

#identify num of genes that are significant in interaction 
ww <-which(FC_All$padj_Interaction_Overall < 0.05)
length(ww)

share.cp <- which(rownames(sig.Pgenes) %in% rownames(sig.Cgenes))
length(share.cp)

wws.both <- which(rownames(FC_All) %in% rownames(sig.Pgenes) & rownames(FC_All) %in% rownames(sig.Cgenes))

FC_All[wws.both,] %>% 
  ggplot(aes(FC_Cond_Overall, FC_Pool_Overall)) +
  geom_point()

#Pool
FC_All$sigP <- FC_All$padj_Pool_Overall
FC_All$sigP[FC_All$padj_Pool_Overall > 0.05] <- NA

PoolMAplot <- ggplot(FC_All, aes(baseMean, FC_Pool_Overall)) +
  geom_point(data = FC_All[is.na(FC_All$sigP),], aes(baseMean, FC_Pool_Overall),color='pink')+
  geom_point(data=FC_All[is.na(FC_All$sigP)==FALSE,], aes(baseMean, FC_Pool_Overall,color=sigP))+
  xlab("Normalized Mean Expression")+
  ylab(expression("log"[2]*"(FC)"))+
  scale_x_log10() +
  scale_color_gradient2(low = "steelblue", mid = "grey",
  high = "pink", midpoint = 0.03,breaks=c(0.049,0.04,0.03,0.02,0.01), labels=c('NS',0.04,0.03,0.02,0.01))+
  my_theme +
  theme(legend.position="none")

PoolMAplot


#Condition

FC_All$sigC <- FC_All$padj_Cond_Overall
FC_All$sigC[FC_All$padj_Cond_Overall > 0.05] <- NA

ConMAplot <- ggplot(FC_All, aes(baseMean, FC_Cond_Overall)) +
  geom_point(data = FC_All[is.na(FC_All$sigC),], aes(baseMean, FC_Cond_Overall),color='pink')+
  geom_point(data=FC_All[is.na(FC_All$sigC)==FALSE,], aes(baseMean, FC_Cond_Overall,color=sigC))+
  xlab("Normalized Mean Expression")+
  ylab(expression("log"[2]*"(FC)"))+
  scale_x_log10() +
  scale_color_gradient2(low = "steelblue", mid = "grey",
  high = "pink", midpoint = 0.03,breaks=c(0.049,0.04,0.03,0.02,0.01), labels=c('NS',0.04,0.03,0.02,0.01), name = "P Value")+
  my_theme +
  theme(axis.title.y=element_blank())

ConMAplot

ggsave(PoolMAplot, file="../Plots/PoolMAplot.pdf", width=10, height=4)
ggsave(ConMAplot, file="../Plots/ConMAplot.pdf", width=10, height=4)

MAplot_PoolCon <- plot_grid(PoolMAplot, ConMAplot, nrow= 2, labels = c('A.','B.'), align="hv", axis="tl", label_size=10)

```


#Volcano Plot pool and condition

```{r}

FC_All$FBgn <- rownames(FC_All)

gene_map_table <- read_lines(file = "../../../LearnMemTolQTL/ProcessedData/gene_map_table_fb_2018_04.tsv",
                skip = 6) %>% 
  str_split(pattern = "\t", simplify = TRUE) %>% 
  as_tibble() %>% 
  filter(V1 == "Dmel")

colnames(gene_map_table) <- c('spp','gname','FBgn','v3','cyt','pos')


gene_map_table$chr <- str_split(gene_map_table$pos, ":",simplify=TRUE)[,1]
temp.s1 <- str_split(gene_map_table$pos, ":",simplify=TRUE)[,2] %>% 
  str_split(fixed(".."),simplify=TRUE)
gene_map_table$startp <- as.numeric(temp.s1[,1])

gene_map_table$stopp <- as.numeric(str_split(temp.s1[,2],fixed("("),simplify = TRUE)[,1])

FC_All_wGenes <- merge(FC_All, gene_map_table, by="FBgn")

#HSP FBGN 
place.g<- c("FBgn0013277",
            "FBgn0001229",
            "FBgn0001226",
            "FBgn0265597",
            "FBgn0013278",
            "FBgn0001225",
            "FBgn0013275",
            "FBgn0013279",
            "FBgn0001233",
            "FBgn0001227",
            "FBgn0001224",
            "FBgn0001223",
            "FBgn0015245")


hsp70 <- gene_map_table[grep("Hsp70", gene_map_table$gname),"FBgn"]

#Pool

Pool_Volcanoplot <- ggplot(FC_All_wGenes, aes(y=-log10(padj_Pool_Overall), x=FC_Pool_Overall, color=log10(baseMean), label=gname)) +
  geom_hline(yintercept=-log10(0.05), color='grey70')+
  geom_vline(xintercept= -1, color='grey70')+
  geom_vline(xintercept= 1, color='grey70')+
  geom_point(size=1.3) +
  geom_text_repel(data = FC_All_wGenes[FC_All_wGenes$FBgn %in% hsp70$FBgn,], show.legend = FALSE,  fontface='italic', color="black", nudge_y=100, size=3, max.overlaps=20, seed=37923,segment.colour = "grey50") +
  ylab(expression("-log"[10]*"(P"[adj]*")")) +
  xlab(expression("log"[2]*"(FC)"))+
  xlim(c(-6.5,6.5)) +
  my_theme +
  scale_color_gradientn(breaks = c(2:5), labels = 10^seq(2,5), name = "Mean\nExpression",colours = rainbow_hcl(8, start = 300, end = 40)) +
  theme(legend.position="none")
 
Pool_Volcanoplot

#Condition

Con_Volcanoplot <- ggplot(FC_All_wGenes, aes(y=-log10(padj_Cond_Overall), x=FC_Cond_Overall, color=log10(baseMean), label=gname)) +
  geom_hline(yintercept=-log10(0.05), color='grey70')+
  geom_vline(xintercept= -1, color='grey70')+
  geom_vline(xintercept= 1, color='grey70')+
  geom_point(size=1.3) +
  geom_text_repel(data = FC_All_wGenes[FC_All_wGenes$FBgn %in% hsp70$FBgn,], show.legend = FALSE,  fontface='italic', color="black", size=3,min.segment.length = 0, max.overlaps=20, segment.colour = "grey50", seed=2749) +
  ylab(expression("-log"[10]*"(P"[adj]*")")) +
  xlab(expression("log"[2]*"(FC)"))+
  xlim(c(-6.5,6.5)) +
  my_theme +
  scale_color_gradientn(breaks = c(2:5), labels = 10^seq(2,5), name = "Mean\nExpression",colours = rainbow_hcl(8, start = 300, end = 40)) +
  theme(axis.title.y=element_blank())

Con_Volcanoplot

PoolConVolPlot<- plot_grid(Pool_Volcanoplot,Con_Volcanoplot, nrow=2,labels = c('A. Pool', 'B. Condition'), rel_widths = c(1,1.3), label_size = 10)

ggsave(Pool_Volcanoplot, filename="../Plots/Pool_Volcanoplot.pdf", width=6.5, height=3)
ggsave(Con_Volcanoplot, filename="../Plots/Con_Volcanoplot.pdf", width=6.5, height=3)


allplot <- plot_grid(PoolMAplot, ConMAplot, Pool_Volcanoplot,Con_Volcanoplot, nrow=2,labels = c('A.', 'B.', 'C.','D.'), rel_widths = c(1,1.3), label_size = 10,align='v', axis='l', greedy=FALSE, hjust = -1.5)

allplot

ggsave(allplot, file="../Plots/Fig4.pdf",width=7.5,height=5)

```


# PCA of samples
# different ways to visualize

```{r}

load("../Data/TTdds_deseq.Rda")
phenodat <- readRDS(file="../Data/Pheno_data_withBatch.Rds")

rlogtransTTdds_deseq <- rlogTransformation(TTdds_deseq, blind=TRUE) 

uncor.pca <- plotPCA(rlogtransTTdds_deseq, intgroup=c("condition", "pool"), returnData=TRUE)

percentVar <- round(100 * attr(uncor.pca, "percentVar"))

ll <- ggplot(uncor.pca, aes(PC1, PC2, color=pool, shape=condition)) +
  geom_point(size=4, alpha = 0.6) + 
  theme(axis.title = element_text(size = 9),
                text = element_text(size = 9))+
  xlab(paste0("PC1: ", percentVar[1],"% variance")) + 
  ylab(paste0("PC2: ", percentVar[2],"% variance")) + 
  #coord_cartesian(xlim = c(-130, 130)) +
  #coord_cartesian(ylim = c(-100, 100), xlim=c(-110,150)) +
  my_theme
ll

ggsave(filename="../Plots/FigS5.pdf", width= 4,height=3)

```


