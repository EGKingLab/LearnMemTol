---
title: "Visualizing_TTRNA_Data"
author: "Patricka Williams-Simon"
date: "8/20/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DESeq2)
library(dplyr)
library(stringr)
library(sva)
library(ggplot2)
```

# DESeqDataSet for all variables, no interaction

```{r}

ThermTolgenecount <- read.csv("../Data/ThermTol_gene_count_matrix.csv", row.names="gene_id")

ThermToldds.ttSS <- DESeqDataSetFromMatrix(countData = ThermTolgenecount, 
                                   colData = Tolpheno_data, 
                                   design = ~ pool + condition)

TTdds_deseq <- DESeq(ThermToldds.ttSS)

TTres.dds <- results(TTdds_deseq)
(TTres.dds <- TTres.dds[order(TTres.dds$padj), ])


TTres.dds_table <- merge(as.data.frame(TTres.dds), 
                       as.data.frame(counts(TTdds_deseq, normalized=TRUE)), 
                       by="row.names", sort=FALSE)
names(TTres.dds_table)[1] <- "Gene"

save(TTres.dds, file = "../Data/TTres.dds.Rda")
save(TTdds_deseq, file = "../Data/TTdds_deseq.Rda")
save(TTres.dds_table, file = "../Data/ThermTol_Noint_resOrdered_padj.Rda")


write.csv(TTres.dds_table, 
          "../Data/ThermTol_Noint_resOrdered_padj.csv", row.names=TRUE)

load("../Data/ThermTol_Noint_resOrdered_padj.Rda")



# Examine plot of p-values
hist(TTres.dds$pvalue, breaks=50, col="grey")

# Examine independent filtering
metadata(TTres.dds)$filterThreshold

plot(metadata(TTres.dds)$filterNumRej, type="b", xlab="quantiles of baseMean", ylab="number of rejections")
```


#MA plot
```{r}
load("../Data/ThermTol_Noint_resOrdered_padj.Rda")

# Could do with built-in DESeq2 function:
DESeq2::plotMA(TTdds_deseq, ylim=c(-10,6))

# see all results available
resultsNames(TTdds_deseq)


results(TTdds_deseq, contrast=c("pool","condition"))

```

#Volcano Plot

```{r}

load("../Data/ThermTol_Noint_resOrdered_padj.Rda")

par(mar=c(5,5,5,5), cex=1.0, cex.main=1.4, cex.axis=1.4, cex.lab=1.4)

TTtop <- as.data.frame(TTres.dds_table)

#Adjusted P values (FDR Q values)
with(TTres.dds_table, plot(log2FoldChange, -log10(padj), pch=20, main="Volcano plot", cex=1.0, xlab=bquote(~Log[2]~fold~change), ylab=bquote(~-log[10]~Q~value)))


with(subset(TTres.dds_table, padj<0.05 & abs(log2FoldChange)>2), points(log2FoldChange, -log10(padj), pch=20, col="red", cex=0.5))

with(subset(TTres.dds_table, padj<0.05 & abs(log2FoldChange)>2), text(log2FoldChange, -log10(padj), labels=subset(rownames(TTtop), TTtop$padj<0.05 & abs(TTtop$log2FoldChange)>2), cex=0.8, pos=3))

#Add lines for absolute FC>2 and P-value cut-off at FDR Q<0.05
abline(v=0, col="black", lty=3, lwd=1.0)
abline(v=-2, col="black", lty=4, lwd=2.0)
abline(v=2, col="black", lty=4, lwd=2.0)
abline(h=-log10(max(TTtop$pvalue[TTtop$padj<0.05], na.rm=TRUE)), col="black", lty=4, lwd=2.0)
```

#Volcano Plot (ggplot2)

```
load("../Data/ThermTol_Noint_resOrdered_padj.Rda")
#TTgene_list <- read.table("../Data/ThermTol_Noint_resOrdered_padj.csv", header=T, sep=",")


TTgene_list <- as.data.frame(ThermTolres.dds_table)

TTdrhs<-TTdrhs%>%mutate(TTdrhs = ifelse(log2FoldChange) >= 2, "A", ifelse(log2FoldChange<=-2, "B", "C" ))


str(TTdrhs)


ThermTol_Volcanoplot <- ggplot(TTdrhs, aes(y=-log10(padj), x=log2FoldChange)) +
  geom_point(aes(colour = Gene), size=2, alpha=1/2 ) +
  geom_hline(yintercept = 1.30) 
  scale_color_manual(values=c('red','blue','black'),labels=c('Up Regulated','Down Regulated','Base Levels'))


ThermTol_Volcanoplot

ggsave(Memgene_Volcanoplot, filename="../Plots/ThermTol_Volcanoplot.pdf", width=6, height=4)


```


#Heat map

```{r}
# Heatmap of count table
library(gplots)

load("../Data/dds_deseq2.Rda")

#use a DESeq()-ready data object
Select <- order(rowMeans(counts(dds_deseq2, normalized=TRUE)), 
                decreasing=TRUE)[1:30]
hmcol <- colorRampPalette(brewer.pal(9, "GnBu"))(100)

heatmap.2(counts(dds_deseq, normalized=TRUE)[Select,], col = hmcol,
          Rowv = FALSE, Colv = FALSE, scale = "none",
          dendrogram = "none", trace = "none", margin = c(10,6))

dev.off()
heatmap.2(assay(rld)[Select,], col = hmcol,
          Rowv = FALSE, Colv = FALSE, scale = "none",
          dendrogram = "none", trace = "none", margin = c(10,6))

dev.off()
heatmap.2(assay(vsd)[Select,], col = hmcol,
          Rowv = FALSE, Colv = FALSE, scale = "none",
          dendrogram = "none", trace = "none", margin = c(10,6))

# Heatmap of the sample-sample distance
#dev.off()
#distRL <- dist(t(assay(rld)))
#Matt <- as.matrix(distRL)
#rownames(Matt) <- colnames(Matt) <- with(colData(dds_deseq),
                                         #paste(treatment, tissue, sep=":"))
#heatmap.2(Matt, trace = "none", col = rev(hmcol), margin=c(8,8))


```

# PCA of samples
# different ways to visualize

```{r}


load("../Data/dds_deseq2.Rda")

rlogtransdds_deseq2 <- rlogTransformation(dds_deseq2, blind=TRUE) #time intensive
vstransdds_deseq2 <- varianceStabilizingTransformation(dds_deseq2, blind = TRUE)

dev.off()
print(plotPCA(rlogtransdds_deseq2, intgroup=c("pool", "condition")))
plotPCA(rlogtransdds_deseq2, intgroup=c("pool"), returnData=FALSE)



# Visualize p-value optimization
attr(res.dds, "filterThreshold")
attr(res_int, "filterThreshold")

#NULL could mean too many DEs & independent (default in results()), filtering did not happen. Solution:

metadata(res.dds)$filterThreshold
metadata(res_int)$filterThreshold

plot(attr(res.dds, "filterNumRej"), type="b",
     xlab="quantiles of 'baseMean'",
     ylab="number of rejections")

# turn off independent filtering and see what happens
resNoFilt <- results(dds_deseq, independentFiltering = FALSE)
table(filtering=(res.dds$padj < 0.1), noFiltering=(resNoFilt$padj < 0.1))

# turn on independent filtering and see what happens
rv <- rowVars(counts(dds_deseq, normalized=TRUE))
resFiltByVar <- results(dds_deseq, filter = rv)
table(rowMean=(res.dds$padj < 0.1), rowVar=(resFiltByVar$padj < 0.1))
```


```

