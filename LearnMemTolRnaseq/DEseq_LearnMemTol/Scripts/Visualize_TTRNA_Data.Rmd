---
title: "Visualizing_TTRNA_Data"
author: "Patricka Williams-Simon"
date: "8/20/2018"
output: html_document
---
https://rpubs.com/kapeelc12/Ballgown
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DESeq2)
library(dplyr)
library(stringr)
library(sva)
library(ggplot2)
library(cowplot)
library(tidyverse)
source(file="../../../Functions/ggplot_theme.R")

```

# MA plot


```{r}
#load("../Data/TTDEseqSVA_resOrdered_padj.Rda")
#load("../Data/TTlrt_inter.Rda")
#load("../Data/TTlrt_pool.Rda")
#load("../Data/TTlrt_condition.Rda")

load("../Data/FCpool.Rda")
load("../Data/FCcon.Rda")
load("../Data/FoldChangeAll.Rda")

FC_All

# Could do with built-in DESeq2 function:
DESeq2::plotMA(TTlrt_condition, ylim=c(-15,10))

# see all results available
resultsNames(TTlrt_condition)


results(TTlrt_condition, contrast=c("pool","condition"))

```

#Volcano Plot

```{r}

par(mar=c(5,5,5,5), cex=1.0, cex.main=1.4, cex.axis=1.4, cex.lab=1.4)

TTtop <- as.data.frame(TTres.dds_table)

#Adjusted P values (FDR Q values)
with(TTres.dds_table, plot(log2FoldChange, -log10(padj), pch=20, main="Volcano plot", cex=1.0, xlab=bquote(~Log[2]~fold~change), ylab=bquote(~-log[10]~Q~value)))


with(subset(TTres.dds_table, padj<0.05 & abs(log2FoldChange)>2), points(log2FoldChange, -log10(padj), pch=20, col="red", cex=0.5))

with(subset(TTres.dds_table, padj<0.05 & abs(log2FoldChange)>2), text(log2FoldChange, -log10(padj), labels=subset(rownames(TTtop), TTtop$padj<0.05 & abs(TTtop$log2FoldChange)>2), cex=0.8, pos=3))

#Add lines for absolute FC>2 and P-value cut-off at FDR Q<0.05
abline(v=0, col="black", lty=3, lwd=1.0)
abline(v=-2, col="black", lty=4, lwd=2.0)
abline(v=2, col="black", lty=4, lwd=2.0)
abline(h=-log10(max(TTtop$pvalue[TTtop$padj<0.05], na.rm=TRUE)), col="black", lty=4, lwd=2.0)
```

#Volcano Plot (ggplot2), pool and condition

```{r}

#pool (H vs L)

TTpoolgene_list <- as.data.frame(FCpool)


TTpoolgene_list <-TTpoolgene_list %>% mutate(FCpool = ifelse(log2FoldChange >= 2, "A", ifelse(log2FoldChange <=-2, "B", "C")))


str(TTpoolgene_list)

TTpoolgene_list <- drop_na(TTpoolgene_list)

TTpool_Vplot <- ggplot(TTpoolgene_list, aes(y=-log10(padj), x=log2FoldChange)) +
  geom_point(size=2, alpha=1/2 ) +
  geom_hline(yintercept = 1.30) +
  #scale_color_manual(values=c('red','blue','black'),labels=c('Up Regulated','Down Regulated','Base Levels')) +
  theme_half_open()


TTpool_Vplot

#ggsave(TTpool_Vplot, filename="../Plots/TTpool_Vplot.pdf", width=6, height=4)


#condition (Incu vs RT)


TTcongene_list <- as.data.frame(FCcon)


TTcongene_list <-TTcongene_list %>% mutate(FCcon = ifelse(log2FoldChange >= 2, "A", ifelse(log2FoldChange <=-2, "B", "C")))


str(TTcongene_list)

TTcongene_list <- drop_na(TTcongene_list)

TTcon_Vplot <- ggplot(TTcongene_list, aes(y=-log10(padj), x=log2FoldChange)) +
  geom_point(size=2, alpha=1/2 ) +
  geom_hline(yintercept = 1.30) +
  #scale_color_manual(values=c('red','blue','black'),labels=c('Up Regulated','Down Regulated','Base Levels')) +
  theme_half_open()


TTcon_Vplot

#ggsave(TTcon_Vplot, filename="../Plots/TTcon_Vplot.pdf", width=6, height=4)

```

#Plot fold change for pairwise: H_Incu vs L_Incu, H_RT vs L_RT, H_Incu vs H_RT, L_Incu vs L_RT
```{r}


#################################################################################################
#########NEED HELP HERE. STARTED WORKING ON THE CODE USING ENOCH"S EXAMPLE BUT GOT STUCK##########
##################################################################################################

plot.dat <- data.frame("gname" = rownames(FC_All), 
                       "Pval"= FC_All$pvalue, 
                       "Padj"= FC_All$padj,
                       "BaseMean"= FC_All$baseMean, stringsAsFactors = FALSE)


#enoch's example

pp<-ggplot(FC_All, aes(FoldChangeDR,FoldChangeHS, color=log10(BaseMean))) +
  geom_hline(yintercept=0,col='grey80')+
  geom_vline(xintercept=0,col='grey80')+
  geom_abline(intercept=0,slope=1,col='grey80',lty=2)+
  geom_point(alpha=1/2)+
 # geom_point(data=pp.dat, aes(FoldChangeDR,FoldChangeHS,color=-log10(Padj+1e-16)), alpha=1/2) +
  ylim(c(-ax.top,ax.top))+
  xlim(c(-ax.top,ax.top))+
  ylab("Fold Change (HS)")+
  xlab("Fold Change (DR)")+
  scale_color_gradientn(colours = rainbow_hcl(8, start = 300, end = 40)) +
  theme(legend.position="none", plot.title = element_text(color="grey50")) +
  ggtitle("Bodies") +
  my_theme


```



#Heat map

```{r}
# Heatmap of count table
library(gplots)

load(file="../Data/.Rda")

load("../Data/TTlrt_inter.Rda")

#use a DESeq()-ready data object

Select <- order(rowMeans(counts(TTlrt_inter, normalized=TRUE)), 
                decreasing=TRUE)[1:30]

hmcol <- colorRampPalette(brewer.pal(9, "GnBu"))(100)

heatmap.2(counts(dds_deseq, normalized=TRUE)[Select,], col = hmcol,
          Rowv = FALSE, Colv = FALSE, scale = "none",
          dendrogram = "none", trace = "none", margin = c(10,6))

dev.off()
heatmap.2(assay(rld)[Select,], col = hmcol,
          Rowv = FALSE, Colv = FALSE, scale = "none",
          dendrogram = "none", trace = "none", margin = c(10,6))

dev.off()
heatmap.2(assay(vsd)[Select,], col = hmcol,
          Rowv = FALSE, Colv = FALSE, scale = "none",
          dendrogram = "none", trace = "none", margin = c(10,6))

# Heatmap of the sample-sample distance
#dev.off()
#distRL <- dist(t(assay(rld)))
#Matt <- as.matrix(distRL)
#rownames(Matt) <- colnames(Matt) <- with(colData(dds_deseq),
                                         #paste(treatment, tissue, sep=":"))
#heatmap.2(Matt, trace = "none", col = rev(hmcol), margin=c(8,8))


```

# PCA of samples
# different ways to visualize

```{r}


load("../Data/TTdds_deseq.Rda")

rlogtransTTdds_deseq <- rlogTransformation(TTdds_deseq, blind=TRUE) #time intensive
vstransTTdds_deseq <- varianceStabilizingTransformation(TTdds_deseq, blind = TRUE)

dev.off()

print(plotPCA(rlogtransTTdds_deseq, intgroup=c("pool", "condition")))
plotPCA(rlogtransTTdds_deseq, intgroup=c("pool"), returnData=FALSE)

###save plots as pdf

# Visualize p-value optimization
attr(res.dds, "filterThreshold")
attr(res_int, "filterThreshold")

#NULL could mean too many DEs & independent (default in results()), filtering did not happen. Solution:

metadata(res.dds)$filterThreshold
metadata(res_int)$filterThreshold

plot(attr(res.dds, "filterNumRej"), type="b",
     xlab="quantiles of 'baseMean'",
     ylab="number of rejections")

# turn off independent filtering and see what happens
resNoFilt <- results(dds_deseq, independentFiltering = FALSE)
table(filtering=(res.dds$padj < 0.1), noFiltering=(resNoFilt$padj < 0.1))

# turn on independent filtering and see what happens
rv <- rowVars(counts(dds_deseq, normalized=TRUE))
resFiltByVar <- results(dds_deseq, filter = rv)
table(rowMean=(res.dds$padj < 0.1), rowVar=(resFiltByVar$padj < 0.1))
```

#Reacrion Norm

```{r}

set.seed(45786)

n <- 500

tb <- tibble(
  Gene = paste0("Gene_", 1:n),
  Tx1 = runif(n, 0, 10),
  Tx2 = runif(n, 10, 20),
  d = as.numeric(scale(Tx2 - Tx1)),
  DE = case_when(
    d > 2 ~ "high",
    d < -2 ~ "low",
    TRUE ~ "NC"
  )
) %>% 
  mutate(DE = factor(DE),
         DE = fct_relevel(DE, "NC", after = 1L))

tbl <- tb %>% 
  dplyr::select(-d) %>% 
  gather(key = "Tx", value = "Exp", -Gene, -DE)

tbl_star <- tbl %>% filter(DE != "NC")

ggplot() +
  geom_line(data = tbl, aes(x = Tx, y = Exp, group = Gene, color = DE),
            alpha = 0.05) +
  geom_line(data = tbl_star,
            aes(x = Tx, y = Exp, group = Gene, color = DE),
            lwd = 0.5) +
  scale_color_manual(values = c("red", "black", "blue"))

```


