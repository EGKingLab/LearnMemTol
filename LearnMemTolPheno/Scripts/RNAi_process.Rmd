---
title: "RNAi_process"
author: "Patricka Williams-Simon & Libby King"
date: "4/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(DESeq2)
library(dplyr)
library(stringr)
library(sva)
library(ggplot2)
library(cowplot)
library(colorspace)
library(ggrepel)
library(tidyverse)
library(multcomp)
library(readxl)
theme_set(theme_cowplot())

source(file="../../../../../kingeg/Functions/ggplot_theme.R")
```

#This script is to analyse RNAi lines that were measured for thermal tolerance using the hot plate.

## Read in processed data

```{r}
ThermDat1 <- read.csv(file="../ProcessedData/RNAi1_tracked_data.csv")
str(ThermDat1)
ThermDat1[1:5,]
ThermDat1$genotype  <- as.character(ThermDat1$genotype)


#add a col set id 
ThermDat1$set_id<- paste(ThermDat1$genotype, ThermDat1$cross, sep="_")


RNAi_backg <- read_excel("../ProcessedData/HeatPlate_autotrack/RNAi_Bckg.xlsx")
str(RNAi_backg)
RNAi_backg[1:5,]

colnames(RNAi_backg) <-c("genotype", "backg_id", "Gname")


ThermDat1 <- left_join(ThermDat1, RNAi_backg, by="genotype")
str(ThermDat1)
ThermDat2 <- left_join(ThermDat2, RNAi_backg, by="genotype")
```

## Data Checking

Use `unique()` to check groups, replicates, genotypes, etc. for issues. You will need a column that specifies which flies you want to compare so work toward getting that set up here and checking for any problems. Use `tally()` to count up how many you have in your groups to make sure that makes sense too. Etc.



```{r}

#removed individuals with incap time of 5 secs or less

ThermDat1<-ThermDat1 %>% filter(incapacitation > 5)
str(ThermDat1)

ThermDat2<-ThermDat2 %>% filter(incapacitation > 5)
str(ThermDat2)

#Visualize after filtering 

p1<- ggplot(ThermDat1, aes(x = incapacitation)) +
  geom_histogram()

p2<- ggplot(ThermDat2, aes(x = incapacitation)) +
  geom_histogram()


#look at the indi
ThermDat1[which(ThermDat1$incapacitation > 300),]
ThermDat2[which(ThermDat2$incapacitation > 300),]


#check number of individuals per genotype 
RNAicounts1 <- ThermDat1%>% group_by(set_id) %>% tally()
RNAicounts2 <- ThermDat2%>% group_by(set_id) %>% tally()

#visualize 
hist(RNAicounts1$n)
hist(RNAicounts2$n)


#identify crosses with more/ less individuals than expected
RNAicounts1[which(RNAicounts1$n > 30),]
RNAicounts1[which(RNAicounts1$n < 30),]
RNAicounts2[which(RNAicounts2$n < 25),]

#cleaning up data. See notes below

#replaced mislabeled genotypes.
ThermDat1[which(ThermDat1$set_id=="60071_25752"), 'cross'] <-25750
ThermDat1[which(ThermDat1$set_id=="33545_3954"), 'genotype'] <-33646

#removed genotype with low number of individuals pehptyped.
ThermDat1 <- ThermDat1 %>% filter(!(set_id %in% c("32913_25750", "32913_3954", "32913_25750")))


ThermDat1$set_id<- paste(ThermDat1$genotype, ThermDat1$cross, sep="_")


unique(ThermDat1$group)
unique(ThermDat1$genotype)

#check to be sure data was removed form list by rerunniung the code above RNAicounts1 <- ThermDat1%>% group_by(set_id) %>% tally()


#check for duplicates in data set
dupsRNAi1 <- which(duplicated(ThermDat1, MARGIN=1, incomparables = FALSE ))
dupsRNAi2 <- which(duplicated(ThermDat2, MARGIN=1, incomparables = FALSE ))

dupsRNAi2<-ThermDat2[171,]


save(dupsRNAi2, file="../ProcessedData/DupsRNAi2.rda")


#read in data sheet with pheno total for RNAi2
RNAi2_ch <- read_excel("../ProcessedData/HeatPlate_autotrack/RNAi_Val2_Chmb_positions.xlsx")
RNAi2_ch$file <- paste0(RNAi2_ch$FileName,"_", RNAi2_ch$Chamber)

#confirm where files were duplicated files from top to bottom
which(duplicated(RNAi2_ch$file))

# confirm where files were duplicated files from bottom to top
which(duplicated(RNAi2_ch$file, fromLast=TRUE))
RNAi2_ch[which(duplicated(RNAi2_ch$file)),]

#remove duplicated rows 
ThermDat2<- ThermDat2[-c(171), ]

#confirm duplicates were removed 
dupsRNAi2 <- which(duplicated(ThermDat2, MARGIN=1, incomparables = FALSE ))


#confirm the total number phenotyped
RNAi2_phenototal <- read_excel("../ProcessedData/HeatPlate_autotrack/RNAi_PhenoTotal.xlsx")
str(RNAi2_phenototal)
RNAi2_phenototal[1:5,]
hist(RNAi2_phenototal$Total_Flies_Phenotyed)



#cleaning up data. See notes below
ThermDat1[which(ThermDat1$set_id=="60071_25752"), 'cross'] <-25750
ThermDat1[which(ThermDat1$set_id=="33545_3954"), 'genotype'] <-33646



#sort data from min to max
RNAiData_sort1 <- ThermDat1[order(ThermDat1$incapacitation),]
RNAiData_sort2 <- ThermDat2[order(ThermDat2$incapacitation),]


#look at distrubution of data
hist(ThermDat1$incapacitation)
str(ThermDat1)

hist(ThermDat2$incapacitation)
str(ThermDat2)



#identify outliers
RNAiData_sort1[1664:1684,]
RNAiData_sort2[1:10,]


```

Dropped all lines with genotype 32913 because the crossed produced a low number of individuals therefore we were not able to meet the minimum number for phenontyping. 
###Dropped 50656 because there was only 2 individuals measured for TT.### 
Merged 60071-25750 and 60071-25752 because there was a typo in file naming and 60071-25752 is not a genotype. The file name column did not change. 
Merged 33545_3954 and 33646_3954  because there was a typo in file naming and 33545_3954 is not a genotype.

In ThermDat2, I removed line *171* because it was duplicated. (11/01/21)


#calculate mean and SEM
```{r}
RNAi_Data1 <- ThermDat1 %>% 
  group_by(set_id) %>% 
  summarise(Incap_Mean = mean(incapacitation),
            Incap_SEM = sd(incapacitation)/sqrt(length(incapacitation)),
            N = length(incapacitation))

which.min(RNAi_Data1$N)
mean(RNAi_Data1$N)

RNAi_Data2 <- ThermDat2 %>% 
  group_by(set_id) %>% 
  summarise(Incap_Mean = mean(incapacitation),
            Incap_SEM = sd(incapacitation)/sqrt(length(incapacitation)),
            N = length(incapacitation))

which.min(RNAi_Data2$N)
mean(RNAi_Data2$N)

#Visulalize distribution with histogram for both mean and raw 
RNAi_histo1 <- ggplot(RNAi_Data1, aes(x = Incap_Mean)) +
  geom_histogram()

RNAi_Datahisto1 <- ggplot(ThermDat1, aes(x = incapacitation)) +
  geom_histogram()

```

#running Model

For each gene compare to Gal4 crosses and background (P2 or P40)


```{r}

#get vector of focal genes
ThermDat1[1:5,]
ThermDat2[1:5,]

Glist1<- unique(ThermDat1$genotype)
str(Glist1)
Glist2<- unique(ThermDat2$genotype)
str(Glist1)

#remove background lines  from Glist 
Glist1<- Glist1[which(!(Glist1 %in% c("36303", "36304")))]
Glist2<- Glist2[which(!(Glist2 %in% c("36303", "36304")))]


nn1<- numeric(length=length(Glist1))
nn2 <- numeric(length=length(Glist2))

counter <- 1


#performing lm and ANOVA
for(foc.gene in Glist1)
  {
  
#foc.gene <- 31167
Gene1 <- ThermDat1 %>% filter(genotype ==foc.gene)

Bk <- ThermDat1 %>% filter(genotype == ifelse(Gene1$backg_id[1]=="attP2",36303,36304))

Gene1 <- rbind(Gene1, Bk)

RNAi_mod1 <- lm(incapacitation ~ set_id, data= Gene1)
 summary(RNAi_mod1)

 str(RNAi_mod1)
 
 aa1<-aov(RNAi_mod1)
 pp<- summary(aa1)
 str(pp)
 pp<-pp[[1]] 
 pp[1,5]
 
nn1[counter]<- pp[1,5]
 
Gene1 %>% 
   group_by(set_id) %>%
   dplyr::summarise(mean(incapacitation))
 counter<-counter+1
 
}


#adusted p-value 
rr <- p.adjust(nn1, method="BH")


#finding significance for three genes within group 
#RhoGAP93B
foc.gene <- 35027
Gene1 <- ThermDat1 %>% filter(genotype ==foc.gene)

Bk <- ThermDat1 %>% filter(genotype == ifelse(Gene1$backg_id[1]=="attP2",36303,36304))

Gene1 <- rbind(Gene1, Bk)

RNAi_mod1 <- lm(incapacitation ~ set_id, data= Gene1)
 summary(RNAi_mod1)

 str(RNAi_mod1)
 
 aa1<-aov(RNAi_mod1)
summary(aa1)


#post-hoc test 
Rho<-TukeyHSD(aa)
plot(Rho)


#dmrt93B
foc.gene <- 50656
Gene1 <- ThermDat1 %>% filter(genotype ==foc.gene)

Bk <- ThermDat1 %>% filter(genotype == ifelse(Gene1$backg_id[1]=="attP2",36303,36304))

Gene1 <- rbind(Gene1, Bk)

RNAi_mod1 <- lm(incapacitation ~ set_id, data= Gene1)
 summary(RNAi_mod1)

 str(RNAi_mod1)
 
 aa1 <-aov(RNAi_mod1)
summary(aa1)


#post-hoc test 
dmrt<-TukeyHSD(aa)
plot(dmrt)


#atpalpha
foc.gene <- 51411
Gene1 <- ThermDat1 %>% filter(genotype ==foc.gene)

Bk <- ThermDat1 %>% filter(genotype == ifelse(Gene1$backg_id[1]=="attP2",36303,36304))

Gene1 <- rbind(Gene1, Bk)

RNAi_mod1 <- lm(incapacitation ~ set_id, data= Gene1)
 summary(RNAi_mod1)

 str(RNAi_mod1)
 
 aa1<-aov(RNAi_mod1)
 summary(aa1)

#post-hoc test 
atp<-TukeyHSD(aa1)
plot(atp)


#merge padj to Glist 
Glist <- cbind(Glist, rr)


Glist <- as_data_frame(Glist,Glist = "unique")
str(Glist)
```


Visualizing data 
```{r}
Gname<- unique(ThermDat$Gname)

Glist <-cbind(Glist, Gname)



foc.gene <- 51411
FGene1 <- ThermDat1 %>% filter(genotype ==foc.gene)

Bk <- ThermDat1 %>% filter(genotype == ifelse(FGene1$backg_id[1]=="attP2",36303,36304))

FGene1 <- rbind(FGene1, Bk)


Atpha_RNAi_plot <- ggplot(FGene1, aes(set_id, incapacitation, color=set_id )) +
  geom_point(position = position_jitter(width = 0.4), alpha = 1/4) +
  stat_summary(fun = mean, geom = "point", pch = 12, size = 5) +
  stat_summary(fun.data = mean_se, 
               geom = "errorbar", 
               color = 'black', width=.3, size=0.5, alpha=1/2) +
  ggtitle("Na pump α subunit (atpα)") +
  guides(col=guide_legend("Group Mean ")) +
  ylab("Incapacitation Time (sec)") +
  xlab("RNAi Line") 
  #my_theme


foc.gene <- 50656
FGene <- ThermDat %>% filter(genotype ==foc.gene)

Bk <- ThermDat %>% filter(genotype == ifelse(FGene$backg_id[1]=="attP2",36303,36304))

FGene <- rbind(FGene, Bk)


dmr_RNAi_plot <- ggplot(FGene, aes(set_id, incapacitation, color=set_id )) +
  geom_point(position = position_jitter(width = 0.4), alpha = 1/4) +
  stat_summary(fun = mean, geom = "point", pch = 12, size = 5) +
  stat_summary(fun.data = mean_se, 
               geom = "errorbar", 
               color = 'black', width=.3, size=0.5, alpha=1/2) +
  ggtitle("doublesex-Mab related 93B (dmr938)") +
  guides(col=guide_legend("Group Mean ")) +
  ylab("Incapacitation Time (sec)") +
  xlab("RNAi Line") 
  #my_theme


foc.gene <- 35027
FGene <- ThermDat %>% filter(genotype ==foc.gene)

Bk <- ThermDat %>% filter(genotype == ifelse(FGene$backg_id[1]=="attP2",36303,36304))

FGene <- rbind(FGene, Bk)


Rho_RNAi_plot <- ggplot(FGene, aes(set_id, incapacitation, color=set_id )) +
  geom_point(position = position_jitter(width = 0.4), alpha = 1/4) +
  stat_summary(fun = mean, geom = "point", pch = 12, size = 5) +
  stat_summary(fun.data = mean_se, 
               geom = "errorbar", 
               color = 'black', width=.3, size=0.5, alpha=1/2) +
  ggtitle("Rho GTPase activating protein at 93B (RhoGAP93B)") +
  guides(col=guide_legend("Group Mean ")) +
  ylab("Incapacitation Time (sec)") +
  xlab("RNAi Line") 
  #my_theme


```


```