---
title: "TT-founder-effect"
author: "Patricka Williams-Simon"
date: "9/10/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(DSPRqtlDataA)
library(tidyverse)
library(ggplot2)
library(cowplot)
theme_set(theme_cowplot())
source(file="../../Functions/ggplot_theme.R")

set.seed(108155)
```
# Identify founders at QTLs 

Goal is to identify the founders effect at the QTLs for thermal tolerance. This data will be used to identify which RILs have low or high haplotype at Q6 and other peaks.


### Get data


```{r}

load(file="../../LearnMemTolPheno/ProcessedData/T_TDATA.rda")

load(file ="../ProcessedData/Peaks_wCIs.rda")

```

### Get haplotype id for each RIL

```{r}
#haplotype data at a given position

tt.peaks <- ci.peak[["Tolsqrtvariable"]]

tt.foc <- tt.peaks[which.max(tt.peaks$LL),]

tt.foc



objname<-paste("A_",tt.foc$chr,"_",tt.foc$Ppos,sep="")
data(list=objname)
geno <- get(objname)
geno <- geno[,c("ril", "AA1","AA2","AA3","AA4","AA5","AA6","AA7","AA8")]

geno$ril <- as.integer(geno$ril)

geno$hard <- paste0("A",apply(geno[,2:9], 1, which.max))
geno$hprob <- apply(geno[,2:9], 1, max)


T_all <- merge(T_TDATA, geno[,c('ril','hard','hprob')], by.x="patRIL",by.y='ril')


#visualize
Q6_eff_plot <- ggplot(T_all, aes(hard, Incapacitation_Mean)) +
  geom_point(position = position_jitter(width = 0.3, seed = 3572), alpha = 1/4) +
  stat_summary(fun = mean, geom = "point", size = 2, color="firebrick3", alpha=0.8) + 
stat_summary(fun.data = mean_se, 
               geom = "errorbar", 
               color = 'firebrick3', width=0.3, linewidth=0.5) +
  ylab("Incapacitation Score") +
  xlab("RIL Founder Haplotype ID at Q6") +
  my_theme

saveRDS(Q6_eff_plot, file = "../Plots/Fig3c.Rds")
ggsave(Q6_eff_plot, filename="../Plots/Q6_eff_plot.pdf", width=6, height=6)


```

### make effect plots for all QTLs (Q1-Q8)

```{r}

QQ <- vector(mode="list", length=nrow(tt.peaks))

for(qq in 1:nrow(tt.peaks))
{
  tt.foc <- tt.peaks[qq,]

  objname<-paste("A_",tt.foc$chr,"_",tt.foc$Ppos,sep="")
  data(list=objname)
  geno <- get(objname)
  geno <- geno[,c("ril", "AA1","AA2","AA3","AA4","AA5","AA6","AA7","AA8")]

  geno$ril <- as.integer(geno$ril)

  geno$hard <- paste0("A",apply(geno[,2:9], 1, which.max))
  geno$hprob <- apply(geno[,2:9], 1, max)
  
  gcounts <- geno %>%
    group_by(hard) %>% tally()

  T_all <- merge(T_TDATA, geno[,c('ril','hard','hprob')],
                 by.x="patRIL",by.y='ril')
  
  

  #visualize
  QQ[[qq]] <- T_all %>%
    filter(hard %in% gcounts$hard[gcounts$n >= 4]) %>%
    ggplot(aes(hard, Incapacitation_Mean)) +
    geom_point(position = position_jitter(width = 0.3, seed = 3572), alpha = 1/4) +
    stat_summary(fun = mean, geom = "point", size = 2, color="firebrick3", alpha=0.8) + 
  stat_summary(fun.data = mean_se, 
               geom = "errorbar", 
               color = 'firebrick3', width=0.3, linewidth=0.5) +
    ylab("Incapacitation Score") +
    xlab(paste0("RIL Founder Haplotype ID at Q",qq)) +
    my_theme
    
    if(qq %in% c(2,4,6,8))
    {
      QQ[[qq]] <- QQ[[qq]] +
        theme(axis.title.y=element_blank())
    }
}



#merge all he graphs into one plot

pall <- plot_grid(plotlist = QQ, ncol = 2,  axis="l", labels = paste0(LETTERS[1:8],"."), label_size = 10, hjust = -0.2, vjust = 1)

ggsave(pall, file="../Plots/FigS4.pdf",width=7.5,height=8)



```

