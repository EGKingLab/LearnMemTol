---
title: "Individual_peak"
author: "EGK & PW-S"
date: "10/28/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DSPRqtl)
library(ggplot2)
library(cowplot)
library(tidyverse)
library(gridExtra)


#conversion table
load(file = "../ProcessedData/DSPR_5_6_parsed.rda")
coord.table$R5pos<-as.numeric(coord.table$R5pos)
coord.table$R6pos<-as.numeric(coord.table$R6pos)

source("../../Functions/mappingfunctions.R")
source("../../Functions/ggplot_theme.R")


```

# Make individual peak plots
  - Get set of peaks
  - Get genes under peaks (all?)
  - highlight DE genes


## Load data
```{r}
#phenotype data
load(file="../../LearnMemTolQTL/ProcessedData/myGenos.rda")
Nrils <- nrow(myGenos$phenotype)
rm(myGenos)

#LOD scores 
load(file="../../LearnMemTolQTL/ProcessedData/Lodscores_3traits.rda")

#Peak data
load(file ="../../LearnMemTolQTL/ProcessedData/Peaks_wCIs.rda")

#DE genes
load(file="../../LearnMemTolQTL/ProcessedData/Learn_genes_under_peak.rda")
load(file="../../LearnMemTolQTL/ProcessedData/Mem_genes_under_peak.rda")

#convert LOD data to long format
#convert 5-6
#convert LOD to p-value
obs.LM_long <-gather(obs.LL, key='Trait', value='LOD', LearnPowerTrans, Memory_Mean)

obs.LM_long <- merge(obs.LM_long, coord.table, by.x=c('chr','Ppos'), by.y=c('R5chr','R5pos'),sort=FALSE)

obs.LM_long$pval <- getP(obs.LM_long$LOD,Nrils,7,Nrils-8)
obs.LM_long$R6pos <- as.numeric(obs.LM_long$R6pos)

lapply(learn.list, nrow)
lapply(Mem.list, nrow)

```

## Make ind plot

```{r}
fdr<-5.5
fwer<-7.3

pfdr <- getP(fdr,Nrils,7,Nrils-8)
pfwer <- getP(fwer,Nrils,7,Nrils-8)

#only do peaks with DEG in them
pad.pos <- 2

foc.peak <- ci.peak[[1]][5,]

  

set <- subset(obs.LM_long, chr==foc.peak$chr & 
                Gpos < (foc.peak$Gpos + pad.pos) &
                Gpos > (foc.peak$Gpos - pad.pos))

line.ww <- 0.5

if(max(set$pval) > pfwer)
{
  top <- max(set$pval)
}else{
  top <- pfwer
}

#peak.plot <- vector(mode="list", length=)

p1 <- ggplot(set, aes(x=R6pos/1e6, y=pval, color=Trait)) +
    geom_line(alpha=0.8, size=line.ww) +
  
  geom_segment(x= -10, xend=30,y=pfwer,yend=pfwer, color='black', size=line.ww) +
  geom_segment(x=-10, xend=30,y=pfdr,yend=pfdr, color='black', size=line.ww, lty=3) +
  ylim(c(0,top)) +
  ylab("Pval")+
  xlab("Position (Mbp)") +
  theme(legend.position = "none") +
  my_theme
p1
#ggsave(p1, file="../Plots/indpeak.pdf",width=4, height=2)




#scale_color_discrete(name='Phenotype',breaks=c('LearnPowerTrans','Memory_Mean'), labels=c('Learning','Memory'))
```





